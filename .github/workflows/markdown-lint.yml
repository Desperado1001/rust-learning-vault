name: ðŸ“ Markdown Lint

on:
  # Run on push to main branch
  push:
    branches:
      - main
    paths:
      - '**.md'

  # Run on pull requests
  pull_request:
    paths:
      - '**.md'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  markdown-lint:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“ Run Markdown Linter
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: |
            **/*.md
            !**/node_modules/**
            !**/.obsidian/**

      - name: ðŸ“‹ Lint Report
        if: failure()
        run: |
          echo "âŒ Markdown linting failed!"
          echo "Please fix the formatting issues in your Markdown files."
          echo ""
          echo "Common issues to check:"
          echo "  - Consistent heading styles"
          echo "  - No trailing spaces"
          echo "  - Proper list formatting"
          echo "  - No duplicate headings"
          echo "  - Proper link formatting"

  markdown-style-check:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Check for Common Issues
        run: |
          echo "ðŸ” Checking for common Markdown issues..."

          # Check for trailing whitespace
          echo "Checking for trailing whitespace..."
          if grep -r --include="*.md" ' $' .; then
            echo "âŒ Found trailing whitespace in Markdown files"
            exit 1
          else
            echo "âœ… No trailing whitespace found"
          fi

          # Check for mixed line endings
          echo "Checking for consistent line endings..."
          if find . -name "*.md" -exec file {} \; | grep -i "crlf" | grep -v ".git"; then
            echo "âš ï¸ Found CRLF line endings (this is OK on Windows)"
          else
            echo "âœ… Line endings are consistent"
          fi

          # Check for TODO/FIXME comments
          echo "Checking for TODO/FIXME comments..."
          if grep -r --include="*.md" -i "TODO\|FIXME" . | grep -v ".git" | grep -v "CHANGELOG.md"; then
            echo "â„¹ï¸ Found TODO/FIXME comments (informational only)"
          fi

          echo "âœ… Style check completed"

  markdown-link-format:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”— Check Link Formats
        run: |
          echo "ðŸ”— Checking Markdown link formats..."

          # Check for malformed wikilinks
          echo "Checking for malformed wikilinks..."
          if grep -r --include="*.md" '\[\[[^]]*\]' . | grep -v "\[\[[^]]*\]\]" | grep -v ".git"; then
            echo "âŒ Found malformed wikilinks"
            grep -r --include="*.md" '\[\[[^]]*\]' . | grep -v "\[\[[^]]*\]\]" | grep -v ".git"
            exit 1
          else
            echo "âœ… All wikilinks are properly formatted"
          fi

          # Check for empty links
          echo "Checking for empty links..."
          if grep -r --include="*.md" '\[\]([^)]*)' . | grep -v ".git"; then
            echo "âŒ Found empty link text"
            grep -r --include="*.md" '\[\]([^)]*)' . | grep -v ".git"
            exit 1
          else
            echo "âœ… No empty links found"
          fi

          echo "âœ… Link format check completed"

  summary:
    runs-on: ubuntu-latest
    needs: [markdown-lint, markdown-style-check, markdown-link-format]
    if: always()

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ“ Markdown Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.markdown-lint.result }}" == "success" ]; then
            echo "âœ… **Markdown Lint**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Markdown Lint**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.markdown-style-check.result }}" == "success" ]; then
            echo "âœ… **Style Check**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Style Check**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.markdown-link-format.result }}" == "success" ]; then
            echo "âœ… **Link Format Check**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Link Format Check**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For more information, see the [Contributing Guide](CONTRIBUTING.md)." >> $GITHUB_STEP_SUMMARY
